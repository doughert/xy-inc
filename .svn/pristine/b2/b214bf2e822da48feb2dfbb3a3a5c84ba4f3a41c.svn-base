package br.org.iamar.firebase.listener;

import javax.annotation.PostConstruct;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.ApplicationContext;
import org.springframework.stereotype.Component;

import com.google.firebase.database.ChildEventListener;
import com.google.firebase.database.DataSnapshot;
import com.google.firebase.database.DatabaseError;
import com.google.firebase.database.FirebaseDatabase;

import br.org.iamar.firebase.model.FirstAccessApp;
import br.org.iamar.sgci.executor.FirstAccessAppExecutor;

@Component
public class FirstAccessAppListener {

	@Autowired
	private FirebaseDatabase firebaseDatabase;

	@Autowired
	private ApplicationContext context;

	private static final Logger LOG = LoggerFactory.getLogger(FirstAccessAppListener.class);

	@PostConstruct
	public void firstAccessAppListener() {

		firebaseDatabase.getReference("firstAccessApp").addChildEventListener(new ChildEventListener() {

			@Override
			public void onCancelled(DatabaseError arg0) {
				LOG.info("firstAccessApp: onCancelled");
			}

			@Override
			public void onChildAdded(DataSnapshot snapshot, String arg1) {
				LOG.info("firstAccessApp: onChildAdded");

				FirstAccessApp firstAccessApp = snapshot.getValue(FirstAccessApp.class);

				FirstAccessAppExecutor executor = context.getBean(FirstAccessAppExecutor.class);

				executor.execute(snapshot.getKey(), firstAccessApp);

			}

			@Override
			public void onChildChanged(DataSnapshot arg0, String arg1) {
				LOG.info("firstAccessAppListener: onChildChanged");

			}

			@Override
			public void onChildMoved(DataSnapshot arg0, String arg1) {
				LOG.info("firstAccessAppListener: onChildMoved");

			}

			@Override
			public void onChildRemoved(DataSnapshot arg0) {
				LOG.info("firstAccessAppListener: onChildRemoved");

			}

		});
	}

}
