package br.org.iamar.sgci;


import javax.persistence.EntityManagerFactory;
import javax.sql.DataSource;

import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.boot.autoconfigure.jdbc.DataSourceBuilder;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.boot.orm.jpa.EntityManagerFactoryBuilder;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;
import org.springframework.orm.jpa.JpaTransactionManager;
import org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.annotation.EnableTransactionManagement;


@Configuration
@EnableTransactionManagement
@EnableJpaRepositories( entityManagerFactoryRef = "carbonEntityManagerFactory", transactionManagerRef = "carbonTransactionManager",
    basePackages = { "br.org.iamar.carbon.repository" } )
public class CarbonDatabaseConfig {

	@Primary
    @Bean( name = "carbonDataSource" )
    @ConfigurationProperties( prefix = "carbon.datasource" )
    public DataSource barDataSource() {

        return DataSourceBuilder.create().build();
    }

	@Primary
    @Bean( name = "carbonEntityManagerFactory" )
    public LocalContainerEntityManagerFactoryBean barEntityManagerFactory(
        EntityManagerFactoryBuilder builder,
        @Qualifier( "carbonDataSource" ) DataSource carbonDataSource ) {

        return builder.dataSource( carbonDataSource ).packages( "br.org.iamar.carbon.model" ).persistenceUnit( "carbon" ).build();
    }


	@Primary
    @Bean( name = "carbonTransactionManager" )
    public PlatformTransactionManager carbonTransactionManager( @Qualifier( "carbonEntityManagerFactory" ) EntityManagerFactory carbonEntityManagerFactory ) {

        return new JpaTransactionManager( carbonEntityManagerFactory );
    }

}
